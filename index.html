<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Happy Birthday! üéÇ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Dancing+Script:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary-pink: #ff6b8b;
            --secondary-pink: #ff9eb5;
            --light-pink: #fff0f3;
            --dark-pink: #e84369;
            --text-color: #333;
            --card-bg: rgba(255, 255, 255, 0.95);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--light-pink) 0%, #ffe8ed 100%);
            min-height: 100vh;
            color: var(--text-color);
            overflow-x: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        /* ===== PASSWORD PAGE ===== */
        #passwordPage {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #ff9eb5 0%, var(--light-pink) 100%);
        }
        
        .password-container {
            background: var(--card-bg);
            padding: 40px 30px;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(255, 107, 139, 0.2);
            text-align: center;
            max-width: 450px;
            width: 90%;
            border: 3px solid var(--primary-pink);
            margin-top: env(safe-area-inset-top);
        }
        
        .password-title {
            font-family: 'Dancing Script', cursive;
            font-size: 2.8em;
            color: var(--dark-pink);
            margin-bottom: 25px;
            font-weight: 700;
        }
        
        .password-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 1.1em;
            border: 3px solid var(--secondary-pink);
            border-radius: 15px;
            margin-bottom: 20px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
            background: white;
        }
        
        .password-input:focus {
            outline: none;
            border-color: var(--primary-pink);
            box-shadow: 0 0 0 3px rgba(255, 107, 139, 0.2);
        }
        
        .password-hint {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 20px;
            font-style: italic;
            line-height: 1.4;
        }
        
        .enter-btn {
            background: linear-gradient(to right, var(--primary-pink), var(--dark-pink));
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 1.2em;
            font-weight: 600;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
            letter-spacing: 1px;
            box-shadow: 0 8px 20px rgba(232, 67, 105, 0.3);
            width: 100%;
        }
        
        .enter-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(232, 67, 105, 0.4);
        }
        
        .enter-btn:active {
            transform: translateY(-1px);
        }
        
        .tiktok-tag {
            position: fixed;
            bottom: 30px;
            right: 20px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            color: var(--dark-pink);
            font-weight: 500;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .tiktok-tag span {
            font-weight: 300;
            color: #666;
        }
        
        /* ===== MAIN CONTENT (Hidden until password correct) ===== */
        #mainContent {
            display: none;
        }
        
        /* ===== CAKE PAGE ===== */
        .page {
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
        }
        
        .page-title {
            font-family: 'Dancing Script', cursive;
            font-size: 2.8em;
            color: var(--dark-pink);
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .page-subtitle {
            font-size: 1.1em;
            color: #666;
            max-width: 600px;
            line-height: 1.6;
            margin: 0 auto;
        }
        
        /* Cake Container - MOVED TO MIDDLE OF SCREEN */
        .cake-container {
            position: relative;
            margin: 30px 0;
            height: 320px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* CHANGED: Center vertically */
        }
        
        .cake {
            position: absolute;
            bottom: 50px; /* CHANGED: Positioned higher */
            width: 250px;
            height: 100px;
            background: linear-gradient(to top, #ffafbd, #ffc3a0);
            border-radius: 15px 15px 0 0;
            box-shadow: inset 0 -10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .cake-top {
            position: absolute;
            bottom: 130px; /* CHANGED: Positioned relative to cake */
            width: 280px;
            height: 40px;
            background: linear-gradient(to bottom, #ffcc99, #ffb780);
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .candles {
            position: absolute;
            bottom: 180px; /* CHANGED: Positioned above cake */
            display: flex;
            gap: 15px;
        }
        
        .candle {
            width: 12px;
            height: 80px;
            background: linear-gradient(to bottom, #ff6b8b, #ff9eb5);
            border-radius: 8px;
            position: relative;
            box-shadow: 0 5px 15px rgba(255, 107, 139, 0.3);
        }
        
        .flame {
            width: 20px;
            height: 40px;
            background: linear-gradient(to top, #ff9500, #ff3300);
            border-radius: 50% 50% 25% 25%;
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 20px #ff9500;
            animation: flicker 0.4s infinite alternate;
        }
        
        @keyframes flicker {
            0% { transform: translateX(-50%) scale(1); }
            100% { transform: translateX(-50%) scale(1.1) rotate(3deg); }
        }
        
        .flame.extinguished {
            opacity: 0;
            transform: translateX(-50%) scale(0);
            transition: all 0.5s ease;
        }
        
        /* Age Message - BELOW CAKE */
        .age-message {
            text-align: center;
            margin-top: 40px; /* CHANGED: More space above */
            margin-bottom: 20px;
            width: 100%;
        }
        
        .age-title {
            font-family: 'Dancing Script', cursive;
            font-size: 2.2em;
            color: var(--dark-pink);
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .age-subtitle {
            font-size: 1em;
            color: #666;
            font-style: italic;
        }
        
        /* Microphone Controls */
        .mic-controls {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 20px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid var(--secondary-pink);
            max-width: 500px;
            width: 90%;
        }
        
        .mic-btn {
            background: linear-gradient(to right, #4dabf7, #228be6);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1em;
            border-radius: 12px;
            cursor: pointer;
            margin: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.3s;
            width: 100%;
            max-width: 250px;
        }
        
        .mic-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(34, 139, 230, 0.3);
        }
        
        .status-text {
            font-size: 1em;
            margin: 15px 0;
            color: #444;
            min-height: 24px;
            line-height: 1.4;
        }
        
        .blow-instruction {
            background: #e9f5ff;
            padding: 12px;
            border-radius: 12px;
            margin-top: 15px;
            border-left: 4px solid #4dabf7;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .navigation {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            width: 90%;
            max-width: 500px;
            justify-content: center;
        }
        
        .nav-btn {
            padding: 14px 25px;
            background: var(--secondary-pink);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.3s;
            flex: 1;
            max-width: 200px;
        }
        
        .nav-btn:hover {
            background: var(--primary-pink);
            transform: translateY(-2px);
        }
        
        .nav-btn.hidden {
            display: none;
        }
        
        .nav-btn.enabled {
            background: linear-gradient(to right, #51cf66, #40c057);
            animation: pulse 1.5s infinite;
        }
        
        /* ===== CARDS PAGE ===== */
        .cards-container {
            width: 100%;
            max-width: 800px;
            height: 500px;
            position: relative;
            margin: 30px auto;
        }
        
        .card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: var(--card-bg);
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--secondary-pink);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            transform: translateX(100%) scale(0.8);
        }
        
        .card.active {
            opacity: 1;
            transform: translateX(0) scale(1);
            z-index: 10;
        }
        
        .card.prev {
            opacity: 0.7;
            transform: translateX(-100%) scale(0.9);
            z-index: 5;
        }
        
        .card.next {
            opacity: 0.7;
            transform: translateX(100%) scale(0.9);
            z-index: 5;
        }
        
        .card-number {
            position: absolute;
            top: 15px;
            right: 20px;
            font-family: 'Dancing Script', cursive;
            font-size: 1.6em;
            color: var(--primary-pink);
            font-weight: 700;
        }
        
        .card-title {
            font-family: 'Dancing Script', cursive;
            font-size: 2.5em;
            color: var(--dark-pink);
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .card-content {
            font-size: 1.1em;
            line-height: 1.6;
            text-align: center;
            margin-bottom: 30px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        
        .media-placeholder {
            width: 250px;
            height: 160px;
            background: linear-gradient(135deg, var(--light-pink), var(--secondary-pink));
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px auto;
            color: var(--dark-pink);
            font-size: 1em;
            border: 2px dashed var(--primary-pink);
        }
        
        .card-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            width: 100%;
            justify-content: center;
        }
        
        .card-btn {
            padding: 12px 25px;
            background: var(--primary-pink);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            flex: 1;
            max-width: 150px;
        }
        
        .progress-dots {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--secondary-pink);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .dot.active {
            background: var(--primary-pink);
            transform: scale(1.3);
        }
        
        /* ===== FINAL MESSAGE ===== */
        .final-message {
            font-family: 'Dancing Script', cursive;
            font-size: 2.8em;
            color: var(--dark-pink);
            text-align: center;
            max-width: 800px;
            line-height: 1.4;
            margin: 40px auto;
            padding: 30px;
            background: var(--card-bg);
            border-radius: 25px;
            border: 3px solid var(--primary-pink);
            box-shadow: 0 20px 40px rgba(255, 107, 139, 0.2);
        }
        
        /* ===== FIREWORKS ===== */
        .firework {
            position: fixed;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
        }
        
        /* ===== iPhone X SPECIFIC ===== */
        @supports(padding: max(0px)) {
            .page, .password-container {
                padding-left: max(20px, env(safe-area-inset-left));
                padding-right: max(20px, env(safe-area-inset-right));
            }
        }
        
        /* ===== ANIMATIONS ===== */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .password-container {
                padding: 35px 25px;
            }
            
            .password-title {
                font-size: 2.3em;
            }
            
            .page-title {
                font-size: 2.3em;
            }
            
            .cake-container {
                height: 280px;
            }
            
            .cake {
                width: 220px;
                height: 90px;
                bottom: 40px;
            }
            
            .cake-top {
                width: 240px;
                height: 35px;
                bottom: 110px;
            }
            
            .candles {
                bottom: 150px;
                gap: 10px;
            }
            
            .candle {
                width: 10px;
                height: 65px;
            }
            
            .flame {
                width: 16px;
                height: 35px;
                top: -40px;
            }
            
            .age-title {
                font-size: 1.8em;
            }
            
            .cards-container {
                height: 450px;
                padding: 15px;
            }
            
            .card {
                padding: 25px 15px;
            }
            
            .card-title {
                font-size: 2em;
            }
            
            .card-content {
                font-size: 1em;
            }
            
            .media-placeholder {
                width: 200px;
                height: 130px;
                font-size: 0.9em;
            }
            
            .final-message {
                font-size: 2.2em;
                padding: 25px;
                margin: 30px 20px;
            }
        }
        
        @media (max-height: 700px) {
            .cake-container {
                height: 250px;
            }
            
            .cake {
                bottom: 30px;
            }
            
            .cake-top {
                bottom: 100px;
            }
            
            .candles {
                bottom: 130px;
            }
            
            .candle {
                height: 60px;
            }
        }
        
        /* Error Message */
        .error-message {
            color: #ff4757;
            margin-top: 10px;
            font-size: 0.85em;
            display: none;
        }
    </style>
</head>
<body>
    <!-- PASSWORD PAGE -->
    <div id="passwordPage">
        <div class="password-container">
            <h1 class="password-title">Enter the secret code</h1>
            <input type="text" class="password-input" id="passwordInput" placeholder="Type the secret phrase...">
            <p class="password-hint">Hint: Noel is the best boyfriend ever (no space at end üòâ)</p>
            <button class="enter-btn" onclick="checkPassword()">Enter</button>
            <p class="error-message" id="passwordError">Incorrect code. Try again!</p>
        </div>
        <div class="tiktok-tag">
            TikTok <span>@ kmdnzk7</span>
        </div>
    </div>

    <!-- MAIN CONTENT (Hidden until password correct) -->
    <div id="mainContent">
        <!-- PAGE 1: CAKE BLOWING -->
        <div class="page" id="cakePage">
            <div class="header">
                <h1 class="page-title">Happy Birthday! üéÇ</h1>
                <p class="page-subtitle">Blow out your candles and make a wish!</p>
            </div>
            
            <div class="cake-container">
                <!-- Candles in the middle -->
                <div class="candles" id="candlesContainer">
                    <!-- Candles generated by JS -->
                </div>
                
                <!-- Cake below candles -->
                <div class="cake"></div>
                <div class="cake-top"></div>
            </div>
            
            <div class="mic-controls">
                <button class="mic-btn" id="startMicBtn">üé§ Start Microphone</button>
                <button class="mic-btn" id="resetBtn" style="display:none;">üïØÔ∏è Relight Candles</button>
                
                <div class="status-text" id="statusText">
                    Click start, allow microphone access, then BLOW out the candles!
                </div>
                
                <div class="blow-instruction">
                    üí® <strong>Blow into your microphone</strong> to extinguish the candles!<br>
                    Make sure your microphone is working and you're in a quiet place.
                </div>
            </div>
            
            <div class="navigation">
                <button class="nav-btn hidden" id="prevBtn">‚Üê Back</button>
                <button class="nav-btn" id="nextBtn" onclick="showCardsPage()">Open Cards ‚Üí</button>
            </div>
        </div>

        <!-- PAGE 2: INTERACTIVE CARDS -->
        <div class="page" id="cardsPage" style="display:none;">
            <div class="header">
                <h1 class="page-title">Cards from your friends üíå</h1>
                <p class="page-subtitle">Swipe or use buttons to navigate</p>
            </div>
            
            <div class="cards-container">
                <!-- Card 1 -->
                <div class="card active" id="card1">
                    <div class="card-number">1/5</div>
                    <h2 class="card-title">From your Frenss</h2>
                    <div class="card-content">
                        <div>
                            <p>Happy birthday Race üí¨üí¨ please no drinking this year üí¨ can't have a repeat of last year. I love you loads and it sucks we're all scattered across the world now because we would've all gone out to our favorite arcade after work üí¨ regardless I hope you have the best day today and remember we love you.</p>
                            <div class="media-placeholder">
                                üì∏ Photo/Videos Placeholder
                            </div>
                        </div>
                    </div>
                    <div class="progress-dots">
                        <div class="dot active" onclick="showCard(0)"></div>
                        <div class="dot" onclick="showCard(1)"></div>
                        <div class="dot" onclick="showCard(2)"></div>
                        <div class="dot" onclick="showCard(3)"></div>
                        <div class="dot" onclick="showCard(4)"></div>
                    </div>
                </div>
                
                <!-- Card 2 -->
                <div class="card" id="card2">
                    <div class="card-number">2/5</div>
                    <h2 class="card-title">From Sarah</h2>
                    <div class="card-content">
                        <div>
                            <p>RACHAELLLL!!! Happy birthday gurl!!!! love you so much and you deserve the best and I pray to God you get nothing but the best. I'm flying in Sunday so I'll see you then! üòä</p>
                            <div class="media-placeholder">
                                üì∏ Photo/Videos Placeholder
                            </div>
                        </div>
                    </div>
                    <div class="progress-dots">
                        <div class="dot" onclick="showCard(0)"></div>
                        <div class="dot active" onclick="showCard(1)"></div>
                        <div class="dot" onclick="showCard(2)"></div>
                        <div class="dot" onclick="showCard(3)"></div>
                        <div class="dot" onclick="showCard(4)"></div>
                    </div>
                </div>
                
                <!-- Card 3 -->
                <div class="card" id="card3">
                    <div class="card-number">3/5</div>
                    <h2 class="card-title">From your Frenss</h2>
                    <div class="card-content">
                        <div>
                            <p>Forever grateful that the universe brought us together. You're the kindest and bestest friend anyone could dream of to matter how far or how long we're separated for, know that this bond we have is unbreakable and I'll always be by your side no matter what. Happy birthday my dear friend</p>
                            <div class="media-placeholder">
                                üì∏ Photo/Videos Placeholder
                            </div>
                        </div>
                    </div>
                    <div class="progress-dots">
                        <div class="dot" onclick="showCard(0)"></div>
                        <div class="dot" onclick="showCard(1)"></div>
                        <div class="dot active" onclick="showCard(2)"></div>
                        <div class="dot" onclick="showCard(3)"></div>
                        <div class="dot" onclick="showCard(4)"></div>
                    </div>
                </div>
                
                <!-- Card 4 -->
                <div class="card" id="card4">
                    <div class="card-number">4/5</div>
                    <h2 class="card-title">Card 4 Title</h2>
                    <div class="card-content">
                        <div>
                            <p>Your custom message here...</p>
                            <div class="media-placeholder">
                                üì∏ Photo/Videos Placeholder
                            </div>
                        </div>
                    </div>
                    <div class="progress-dots">
                        <div class="dot" onclick="showCard(0)"></div>
                        <div class="dot" onclick="showCard(1)"></div>
                        <div class="dot" onclick="showCard(2)"></div>
                        <div class="dot active" onclick="showCard(3)"></div>
                        <div class="dot" onclick="showCard(4)"></div>
                    </div>
                </div>
                
                <!-- Card 5 -->
                <div class="card" id="card5">
                    <div class="card-number">5/5</div>
                    <h2 class="card-title">Card 5 Title</h2>
                    <div class="card-content">
                        <div>
                            <p>Your custom message here...</p>
                            <div class="media-placeholder">
                                üì∏ Photo/Videos Placeholder
                            </div>
                        </div>
                    </div>
                    <div class="progress-dots">
                        <div class="dot" onclick="showCard(0)"></div>
                        <div class="dot" onclick="showCard(1)"></div>
                        <div class="dot" onclick="showCard(2)"></div>
                        <div class="dot" onclick="showCard(3)"></div>
                        <div class="dot active" onclick="showCard(4)"></div>
                    </div>
                </div>
            </div>
            
            <div class="card-controls">
                <button class="card-btn" onclick="prevCard()">‚Üê Previous</button>
                <button class="card-btn" onclick="nextCard()">Next ‚Üí</button>
            </div>
            
            <div class="navigation">
                <button class="nav-btn" onclick="showCakePage()">‚Üê Back to Cake</button>
                <button class="nav-btn" onclick="showFinalMessage()">See Final Message ‚Üí</button>
            </div>
        </div>

        <!-- PAGE 3: FINAL MESSAGE -->
        <div class="page" id="finalPage" style="display:none;">
            <div class="final-message">
                I love you baby don't ever doubt that<br>
                I wish you the happiest birthday ‚ù§Ô∏è
            </div>
            <div class="navigation">
                <button class="nav-btn" onclick="showCardsPage()">‚Üê Back to Cards</button>
                <button class="nav-btn" onclick="location.reload()">Start Over</button>
            </div>
        </div>
    </div>

    <script>
        // ===== PASSWORD FUNCTIONALITY =====
        const CORRECT_PASSWORD = "Noel is the best boyfriend ever";
        
        function checkPassword() {
            const input = document.getElementById('passwordInput').value.trim();
            const error = document.getElementById('passwordError');
            
            if (input === CORRECT_PASSWORD) {
                document.getElementById('passwordPage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                createFireworks(20); // Celebration fireworks
                // Scroll to top for iPhone X
                window.scrollTo(0, 0);
            } else {
                error.style.display = 'block';
                document.getElementById('passwordInput').style.borderColor = '#ff4757';
                setTimeout(() => {
                    error.style.display = 'none';
                    document.getElementById('passwordInput').style.borderColor = '';
                }, 3000);
            }
        }
        
        // Enter key support for password
        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // ===== CAKE BLOWING FUNCTIONALITY =====
        const CONFIG = {
            numCandles: 8,
            blowThreshold: 0.06,
        };

        let audioContext;
        let analyser;
        let microphone;
        let isListening = false;
        let candlesLit = CONFIG.numCandles;
        let currentCardIndex = 0;
        const cards = document.querySelectorAll('.card');

        // Create candles
        function createCandles() {
            const container = document.getElementById('candlesContainer');
            container.innerHTML = '';
            for (let i = 0; i < CONFIG.numCandles; i++) {
                const candleDiv = document.createElement('div');
                candleDiv.className = 'candle';
                candleDiv.id = `candle-${i}`;
                
                const flameDiv = document.createElement('div');
                flameDiv.className = 'flame';
                flameDiv.id = `flame-${i}`;
                
                candleDiv.appendChild(flameDiv);
                container.appendChild(candleDiv);
            }
        }

        // Initialize candles
        createCandles();

        // Microphone functionality
        document.getElementById('startMicBtn').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: false
                    }
                });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                
                microphone.connect(analyser);
                analyser.fftSize = 256;
                
                document.getElementById('statusText').textContent = "Microphone ready! BLOW to extinguish candles! üí®";
                document.getElementById('startMicBtn').style.display = 'none';
                document.getElementById('resetBtn').style.display = 'inline-block';
                isListening = true;
                
                detectBlowing();
                
            } catch (err) {
                document.getElementById('statusText').textContent = "Error: Please allow microphone access.";
                console.error('Microphone error:', err);
            }
        });

        // Reset candles
        document.getElementById('resetBtn').addEventListener('click', () => {
            candlesLit = CONFIG.numCandles;
            
            for (let i = 0; i < CONFIG.numCandles; i++) {
                const flame = document.getElementById(`flame-${i}`);
                flame.classList.remove('extinguished');
            }
            
            document.getElementById('statusText').textContent = "Candles relit! Blow again! üí®";
            isListening = true;
            detectBlowing();
        });

        // Blow detection
        function detectBlowing() {
            if (!isListening) return;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            function analyze() {
                if (!isListening) return;
                
                analyser.getByteFrequencyData(dataArray);
                
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                const average = sum / bufferLength;
                const normalizedVolume = average / 256;
                
                if (normalizedVolume > CONFIG.blowThreshold && candlesLit > 0) {
                    blowCandle();
                    document.getElementById('statusText').textContent = "BLOW DETECTED! üí®";
                    document.getElementById('statusText').style.color = "#ff4757";
                    setTimeout(() => {
                        document.getElementById('statusText').style.color = "";
                    }, 500);
                }
                
                requestAnimationFrame(analyze);
            }
            
            analyze();
        }

        // Extinguish candle
        function blowCandle() {
            if (candlesLit <= 0) return;
            
            const candleIndex = CONFIG.numCandles - candlesLit;
            const flame = document.getElementById(`flame-${candleIndex}`);
            
            flame.classList.add('extinguished');
            
            // Play sound
            playExtinguishSound();
            
            candlesLit--;
            
            if (candlesLit === 0) {
                setTimeout(() => {
                    document.getElementById('statusText').textContent = "üéâ ALL CANDLES BLOWN! Make a wish!";
                    document.getElementById('statusText').style.color = "#51cf66";
                    createFireworks(50); // Fireworks when all candles blown
                    isListening = false;
                    
                    // Enable next button
                    const nextBtn = document.getElementById('nextBtn');
                    nextBtn.classList.add('enabled');
                }, 800);
            }
        }

        // Sound effect
        function playExtinguishSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
            } catch (e) {
                console.log("Audio not supported");
            }
        }

        // ===== PAGE NAVIGATION =====
        function showCardsPage() {
            if (candlesLit === 0) {
                document.getElementById('cakePage').style.display = 'none';
                document.getElementById('cardsPage').style.display = 'flex';
                createFireworks(20); // Fireworks when going to cards
                document.getElementById('prevBtn').classList.remove('hidden');
                // Scroll to top for iPhone X
                window.scrollTo(0, 0);
            } else {
                alert("Please blow out all the candles first! üí®");
            }
        }

        function showCakePage() {
            document.getElementById('cardsPage').style.display = 'none';
            document.getElementById('cakePage').style.display = 'flex';
            window.scrollTo(0, 0);
        }

        function showFinalMessage() {
            document.getElementById('cardsPage').style.display = 'none';
            document.getElementById('finalPage').style.display = 'flex';
            createFireworks(100); // Big fireworks for final message
            window.scrollTo(0, 0);
        }

        // ===== CARDS FUNCTIONALITY =====
        function showCard(index) {
            currentCardIndex = index;
            updateCards();
        }

        function prevCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                updateCards();
            }
        }

        function nextCard() {
            if (currentCardIndex < cards.length - 1) {
                currentCardIndex++;
                updateCards();
            }
        }

        function updateCards() {
            cards.forEach((card, index) => {
                card.classList.remove('active', 'prev', 'next');
                
                if (index === currentCardIndex) {
                    card.classList.add('active');
                } else if (index < currentCardIndex) {
                    card.classList.add('prev');
                } else {
                    card.classList.add('next');
                }
            });
            
            // Update dots
            document.querySelectorAll('.dot').forEach((dot, index) => {
                dot.classList.remove('active');
                if (index === currentCardIndex) {
                    dot.classList.add('active');
                }
            });
        }

        // ===== FIREWORKS =====
        function createFireworks(count) {
            const colors = ['#ff6b8b', '#4dabf7', '#51cf66', '#ffd43b', '#cc5de8'];
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    firework.style.left = Math.random() * 100 + 'vw';
                    firework.style.top = Math.random() * 100 + 'vh';
                    
                    document.body.appendChild(firework);
                    
                    // Explosion animation
                    const size = 5 + Math.random() * 10;
                    const animation = firework.animate([
                        { transform: 'scale(0)', opacity: 1 },
                        { transform: `scale(${size})`, opacity: 0 }
                    ], {
                        duration: 800 + Math.random() * 800,
                        easing: 'cubic-bezier(0.215, 0.61, 0.355, 1)'
                    });
                    
                    animation.onfinish = () => firework.remove();
                }, i * 50);
            }
        }

        // Initialize cards
        updateCards();

        // Swipe functionality for cards
        let touchStartX = 0;
        let touchEndX = 0;
        
        document.querySelector('.cards-container').addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });
        
        document.querySelector('.cards-container').addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });
        
        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swipe left
                    nextCard();
                } else {
                    // Swipe right
                    prevCard();
                }
            }
        }

        // iPhone X safe area handling
        function isiPhoneX() {
            return /iPhone X|iPhone 11|iPhone 12|iPhone 13|iPhone 14/.test(navigator.userAgent) && /iPhone/.test(navigator.userAgent);
        }

        console.log("üéâ Birthday Website Ready!");
        console.log("Cake and candles moved to middle of screen");
        console.log("Fireworks added back!");
    </script>
</body>
</html>
